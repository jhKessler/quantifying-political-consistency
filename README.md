# Quantifying Political Consistency

This repository contains a project to analyze and predict political voting behavior based on party manifestos.

## Project Structure

- `src/`: Contains the main source code for the project.
- `data/`: Raw data, including PDFs of parliamentary documents (`drucksachen`).
- `input/`: Input files required for the pipeline, such as manifestos URLs and polling data.
- `output/`: Stores intermediate and final data files, models, and predictions.
- `notebooks/`: Jupyter notebooks for analysis and visualization.

## Setup

Before running the scripts, you need to set up your environment variables.

1. Create a new file named `.env` in the root of the project.
2. Copy the contents of `.env.example` into your new `.env` file.
3. Fill in the required API keys for the services you want to use (e.g., `OPENAI_API_KEY`, `DEEPSEEK_API_KEY`).

```dotenv
# .env
OPENAI_API_KEY="your_openai_api_key"
DEEPSEEK_BASE_URL="https://api.deepseek.com"
DEEPSEEK_API_KEY="your_deepseek_api_key"
```

## Pipeline Scripts

The main pipeline is executed through a series of scripts in the `src/` directory. They should be run in the following order.

### 1. `src/run_preprocessing.py`

This script prepares the raw data for the project.

**What it does:**
- Checks for the existence of required input files: `input/manifestos.csv` and `input/sonntagsfragen.xlsx`.
- Creates the `data/` and `output/` directories if they don't exist.
- Scrapes vote information from the web.
- Downloads party manifestos as PDFs.
- Processes the scraped data and manifestos into a structured format (`output/votes.parquet` and `output/cleaned_manifestos.parquet`).

**How to run:**
```bash
python src/run_preprocessing.py
```

### 2. `src/run_prediction.py`

This script uses a Large Language Model (LLM) via an API to predict how a political party would vote on a specific parliamentary proposal, based on the contents of its election manifesto.

**What it does:**
- Loads the preprocessed votes and manifestos data.
- For each party, it queries an LLM (e.g., GPT-4) to get a reasoned prediction (`Yes`, `No`, `Abstention`) for each vote.
- It enriches the prediction data with additional features, such as whether the party is in government and whether the proposal originates from the party itself.
- The final enriched dataset is saved to a parquet file.

**How to run:**
This script accepts command-line arguments to specify the output file name and the API to use.

```bash
python src/run_prediction.py --name <output_name> --api-provider <provider> --model <model_name>
```

**Arguments:**
- `--name` (required): A name for the output file, which will be saved as `output/predictions_<name>.parquet`.
- `--api-provider`: The API provider to use. Choices: `openai`, `deepseek`. Default: `openai`.
- `--model`: The specific model to use from the provider. Default: `gpt-4.1`.

Example:
```bash
python src/run_prediction.py --name gpt4_predictions --api-provider openai --model gpt-4-turbo
```

### 3. `src/run_training.py`

This script trains a machine learning model (XGBoost) to predict the actual voting behavior of parties.

**What it does:**
- Loads the predictions generated by the previous script.
- Performs feature engineering to prepare the data for modeling. This includes one-hot encoding categorical variables.
- Splits the data into a training set and a hold-out test set.
- Trains an XGBoost classifier on the training data to predict the `ground_truth` vote.
- Saves the trained model (`output/xgboost_model.pkl`), the label encoder (`output/label_encoder.pkl`), and the test data (`output/xgboost_test_data.parquet`) for later evaluation.

**How to run:**
```bash
python src/run_training.py
```

### 4. `src/run_predict_passage.py`

This script uses the trained model to predict the outcome of parliamentary votes (i.e., whether a bill will pass or fail) and evaluates the model's performance.

**What it does:**
- Loads the hold-out test data and the trained XGBoost model.
- Predicts the vote of each party on the proposals in the test set.
- Aggregates these party-level predictions into a final vote outcome by considering the number of seats each party holds in parliament.
- Compares the predicted outcomes against the actual ground truth results.
- Prints a confusion matrix to summarize the performance.

**How to run:**
```bash
python src/run_predict_passage.py
```
